<script>
let sessionToken = null;

function login() {
  const email = document.getElementById('email').value;
  document.getElementById('error-msg').innerText = '';

  const hashedEmail = btoa(email)
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, ''); // âœ… web-safe

  google.script.run
    .withSuccessHandler(response => {
      if (response.success) {
        document.getElementById('error-msg').innerText = 'Login link sent to your email.';
      } else {
        document.getElementById('error-msg').innerText = 'Error sending login link. Please try again.';
      }
    })
    .withFailureHandler(err => {
      document.getElementById('error-msg').innerText = err.message;
    })
    .sendLoginLink(hashedEmail);
}


function showApp() {
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadBalance();
}

function loadBalance(email) {
  google.script.run
    .withSuccessHandler(balance => {
      document.getElementById('balance').innerText = balance.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      renderBalance(balance);
    })
    .withFailureHandler(err => {
      alert(err.message);
    })
    .getUserBalanceByEmail(email);
}
</script>
